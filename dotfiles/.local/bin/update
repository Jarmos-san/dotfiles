#!/usr/bin/env python3

"""Simple script to run system updates across different distributions easy peasy!

Author: Somraj Saha <contact@jarmos.dev>
License: MIT
"""

import datetime
import platform
import subprocess
import sys
from argparse import ArgumentParser, Namespace

# Message labels with their respective colour codes
_RESET = "\x1b[0m"
_BLUE = "\x1b[94m"
_GREEN = "\x1b[92m"
# _YELLOW = "\x1b[93m"
# _WARN = f"[{_YELLOW}WARN{_RESET}]"
_RED = "\x1b[31m"
_INFO = f"[{_BLUE}INFO{_RESET}]"
_SUCCESS = f"[{_GREEN}SUCCESS{_RESET}]"
_ERROR = f"[{_RED}ERROR{_RESET}]"


def parse_args() -> Namespace:
    """Parse and return the CLI arguments.

    Returns:
        An argparse.Namespace object containing the parsed arguments.
    """
    current_year = datetime.datetime.now(datetime.timezone.utc).year
    description = "intelligently update the system packages"
    epilog = f"Â© Somraj Saha 2018-{current_year} <contact@jarmos.dev>"

    parser = ArgumentParser(description=description, epilog=epilog)

    return parser.parse_args()


def run_linux_updates() -> None:
    """Detect the Linux distribution and run system updates accordingly.

    Supported distributions:
      - Ubuntu (apt-get)
      - Debian (apt-get)
      - Fedora (dnf)

    This function executes the appropriate package manager commands for
    updating system packages and removing unused dependencies. It uses
    `subprocess.run(..., check=True)` to ensure errors are surfaced.

    If the distribution is not recognized, the function logs an error
    and terminates the program with a non-zero exit code.
    """
    distro = platform.freedesktop_os_release().get("NAME", "")

    match distro:
        case "Ubuntu" | "Debian":
            print(f"{_INFO} Updating {distro} system...")
            subprocess.run(["sudo", "apt-get", "update"], check=True)
            subprocess.run(["sudo", "apt-get", "upgrade", "--yes"], check=True)
            subprocess.run(
                ["sudo", "apt-get", "autoremove", "--purge", "--yes"], check=True
            )
            print(f"{_SUCCESS} {distro} APT packages upgrade complete!")
        case "Fedora":
            print(f"{_INFO} Updating {distro} system...")
            subprocess.run(["sudo", "dnf", "upgrade", "--assumeyes"], check=True)
            subprocess.run(["sudo", "dnf", "autoremove", "--assumeyes"], check=True)
            print(f"{_SUCCESS} {distro} APT packages upgrade complete!")
        case _:
            print(f"{_ERROR} Failed to identify system information...exiting!")
            sys.exit(1)


def homebrew_installed() -> bool:
    """Determine whether Homebrew is installed and accessible.

    This function checks for the presence of the `brew` executable by attempting to run
    `brew --version`. No output is displayed during the check.

    Returns:
        `True`: Homebrew is installed and the `brew` command can be executed.
        `False`: Homebrew is not installed, not available on the system `PATH` or
            returned an unexpected error during its execution.
    """
    try:
        subprocess.run(["brew", "--version"], check=True, stdout=subprocess.DEVNULL)
        return True
    except (FileNotFoundError, subprocess.CalledProcessError):
        return False


def run_homebrew_updates() -> None:
    """Run system package updates using Homebrew.

    This function executes the standard Homebrew maintenance sequence:
        - `brew update` to refresh the available package definitions.
        - `brew upgrade` to upgrade installed formulae and casks.
        - `brew autoremove` to removed unused dependency packages.
        - `brew cleanup` to remove outdated files and cached data.

    All the commands are executed with the `check=True` parameter to raise a
    `subprocess.CalledProcessError` to be raised if any step fails.

    Raises:
        subprocess.CalledProcessError: If any Homebrew command exits with a non-zero
            status.
    """
    print(f"{_INFO} Running Homebrew updates")

    subprocess.run(["brew", "update"], check=True)
    subprocess.run(["brew", "upgrade"], check=True)
    subprocess.run(["brew", "autoremove"], check=True)
    subprocess.run(["brew", "cleanup"], check=True)

    print(f"{_SUCCESS} Homebrew package upgrades complete!")


def run_zsh_updates() -> None:
    """Update the ZSH plugins."""


def main() -> None:
    """Entrypoint of the script."""
    # Parse the CLI arguments of the script
    parse_args()

    # Run the package updates for a Linux distribution
    if platform.uname().system == "Linux":
        run_linux_updates()

    # Run the Homebrew package updates
    if homebrew_installed():
        run_homebrew_updates()

    print(f"{_SUCCESS} System update complete...exiting now")


if __name__ == "__main__":
    main()
